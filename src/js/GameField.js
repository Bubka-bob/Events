import Gnome from "./Gnome.js";
import Image from "../img/gnome.png";
import { startNewGame } from "../index.js";

export default class GameField {
  constructor(rows, cols, intervalTime) {
    this.rows = rows; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
    this.cols = cols; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤
    this.cellCount = rows * cols; // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–µ—Ç–æ–∫
    this.intervalTime = intervalTime || 1000; // –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ—è–≤–ª–µ–Ω–∏—è –≥–Ω–æ–º–∞
    this.container = document.getElementById('game-field'); // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
    this.cells = []; // –ú–∞—Å—Å–∏–≤ –≤—Å–µ—Ö –∏–≥—Ä–æ–≤—ã—Ö –∫–ª–µ—Ç–æ–∫
    this.scoreEl = document.getElementById('score'); // –≠–ª–µ–º–µ–Ω—Ç —Å—á—ë—Ç–∞ –∏–≥—Ä–æ–∫–∞
    this.missesEl = document.getElementById('misses'); // –≠–ª–µ–º–µ–Ω—Ç —á–∏—Å–ª–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤
    this.score = 0; // –¢–µ–∫—É—â–∏–π —Å—á—ë—Ç
    this.missedHits = 0; // –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —É–¥–∞—Ä–æ–≤
    this.isPlaying = false; // –§–ª–∞–≥ –∏–≥—Ä—ã
    this.gnome = new Gnome("./img/gnome.png"); // –ì–Ω–æ–º
    this.currentPosition = null; // –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è –≥–Ω–æ–º–∞
    this.setupEvents(); // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π
  }

  setupEvents() {
    this.createCells(); // –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º –∫–ª–µ—Ç–∫–∏

    // –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –∫ –∫–∞–∂–¥–æ–π –∫–ª–µ—Ç–∫–µ
    this.cells.forEach((cell, idx) => {
      cell.addEventListener('click', () => {
        if (this.isPlaying && idx === this.currentPosition) {
          this.hitSuccess(); // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç
        }
      });
    });
  }

  hitSuccess() {
    this.score++; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç
    this.updateScoreDisplay(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    this.resetMissedHits(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —É–¥–∞—Ä—ã
    this.hideCurrentGnome(); // –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –≥–Ω–æ–º–∞
    this.spawnRandomGnome(); // –ü–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤—ã–π –≥–Ω–æ–º
  }

  updateScoreDisplay() {
    this.scoreEl.textContent = this.score.toString(); // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
  }

  updateMissesDisplay() {
    this.missesEl.textContent = this.missedHits.toString(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤
  }

  resetMissedHits() {
    this.missedHits = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–º–∞—Ö–æ–≤
    this.updateMissesDisplay(); // –û–±–Ω–æ–≤–ª—è–µ–º UI
  }

  hideCurrentGnome() {
    if (this.currentPosition !== null) {
      this.gnome.removeFrom(this.cells[this.currentPosition]); // –£–¥–∞–ª—è–µ–º –≥–Ω–æ–º–∞ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–ª–µ—Ç–∫–∏
    }
  }

  spawnRandomGnome() {
    this.currentPosition = this.randomCell(); // –ü–æ–ª—É—á–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
    this.gnome.renderTo(this.cells[this.currentPosition]); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–Ω–æ–º–∞
    setTimeout(() => {
      this.hideCurrentGnome(); // –ß–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É —Å–∫—Ä—ã–≤–∞–µ–º –≥–Ω–æ–º–∞
      this.spawnRandomGnome(); // –ü–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤—ã–π –≥–Ω–æ–º
    }, 1000); // –ó–∞–¥–µ—Ä–∂–∫–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
  }

  missHit() {
    this.missedHits++;
    this.updateMissesDisplay(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å —á–∏—Å–ª–æ–º –ø—Ä–æ–ø—É—Å–∫–æ–≤
    if (this.missedHits >= 5) {
      this.stopGame(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–≥—Ä—É, –µ—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤
    }
  }

  gameOver() {
    let resultMessage = document.createElement('div');
    resultMessage.id = 'result-message';
    resultMessage.innerText = `
      üéâ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!\n\nüí• –ü–æ–ø–∞–ª–∏: ${this.score}\n‚ùå –ü—Ä–æ–ø—É—Å—Ç–∏–ª–∏: ${this.missedHits}`;
    resultMessage.style.position = 'absolute';
    resultMessage.style.top = '50%';
    resultMessage.style.left = '50%';
    resultMessage.style.transform = 'translate(-50%, -50%)';
    resultMessage.style.backgroundColor = '#ffffff';
    resultMessage.style.padding = '20px';
    resultMessage.style.borderRadius = '10px';
    resultMessage.style.boxShadow = '0 0 10px rgba(0,0,0,0.3)';
    resultMessage.style.fontSize = '1.5rem';
    resultMessage.style.color = '#333';
    resultMessage.style.zIndex = '1000';
    resultMessage.style.textAlign = 'center';

    document.body.append(resultMessage);

    // –£–¥–∞–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
    setTimeout(() => {
      document.body.removeChild(resultMessage);
      startNewGame(); // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É
    }, 3000); // –°–æ–æ–±—â–µ–Ω–∏–µ –∏—Å—á–µ–∑–∞–µ—Ç —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
  }
  stopGame() {
    clearInterval(this.timer); // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä
    this.isPlaying = false; // –ó–∞–≤–µ—Ä—à–∞–µ–º –∏–≥—Ä—É
  }

  startGame() {
    this.isPlaying = true; // –°—Ç–∞—Ä—Ç—É–µ–º –∏–≥—Ä—É
    this.spawnRandomGnome(); // –ü–æ—è–≤–ª—è–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –≥–Ω–æ–º
    this.timer = setInterval(() => {
      this.missHit(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–∏—Å–ª–æ –ø—Ä–æ–ø—É—Å–∫–æ–≤
    }, this.intervalTime);
  }

  createCells() {
    for (let i = 0; i < this.cellCount; i++) {
      const cell = document.createElement('div');
      cell.classList.add('game-cell'); // –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –∫–ª–µ—Ç–∫—É
      this.cells.push(cell); // –î–æ–±–∞–≤–ª—è–µ–º –µ—ë –≤ –º–∞—Å—Å–∏–≤
      this.container.append(cell); // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    }
  }

  randomCell() {
    return Math.floor(Math.random() * this.cellCount); // –°–ª—É—á–∞–π–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –≥–Ω–æ–º–∞
  }
}

